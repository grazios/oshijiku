name: Deploy to Xserver

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npx vitest run

  deploy:
    needs: test
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Xserver via SCP
        run: |
          scp -P 10022 -i ~/.ssh/oshijiku.pem \
            -o StrictHostKeyChecking=no \
            index.html style.css app.js core.js \
            xs536554@sv13378.xserver.jp:/home/xs536554/oshijiku.com/public_html/
          
          # API & uploads directories
          ssh -i ~/.ssh/oshijiku.pem -p 10022 xs536554@sv13378.xserver.jp 'mkdir -p /home/xs536554/oshijiku.com/public_html/api /home/xs536554/oshijiku.com/public_html/uploads'
          scp -P 10022 -i ~/.ssh/oshijiku.pem \
            -o StrictHostKeyChecking=no \
            api/* \
            xs536554@sv13378.xserver.jp:/home/xs536554/oshijiku.com/public_html/api/
          scp -P 10022 -i ~/.ssh/oshijiku.pem \
            -o StrictHostKeyChecking=no \
            uploads/.htaccess \
            xs536554@sv13378.xserver.jp:/home/xs536554/oshijiku.com/public_html/uploads/

      - name: Verify deployment
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://oshijiku.com)
          if [ "$STATUS" != "200" ]; then
            echo "❌ Deploy verification failed: HTTP $STATUS"
            exit 1
          fi
          echo "✅ Deploy OK: HTTP $STATUS"
